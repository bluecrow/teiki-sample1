<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>継続画面 - 四本目の剣(4thSword)</title>
<!--link rel="stylesheet" href="default.css"-->
<style>
.mini1 { width: 40px; }
.mini2 { width: 80px; }
.mini3 { width: 120px; }
th, td { border: 1px gray solid }
</style>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>
<body>
<h1>継続画面 - 四本目の剣(4thSword)</h1>
<div style="color: red">現在開発中です</div>
<img src="logo1.png" /><br>
<a href="index.html">新規登録はこちら</a>　
<a href="result/charalist.html">キャラクターリストはこちら</a>
<form id="login" action="login.php" method="post">
<h2>ログイン</h2>
ENo.<input id="eno" name="eno" type="number" min="1" value="" class="mini2">
Password <input id="password" name="password"  type="password" value="" class="mini3">
<input id="login_button" type="button" value="ログイン">
</form>
<div id="error" style="color: red;"></div>
<div id="otsukare" style="display: none; font-size: 24px;">
<br><br>
宣言完了です。お疲れ様でした。
</div> 
<form id="sengen" action="login.html" method="post" style="display: none;">
<h2>ENo.<span id="eno_show"></span> <span id="name_show"></span>（ニックネーム：<span id="nick_show"></span>）</h2>
<input id="eno_hidden" name="eno" type="hidden" value="" />
<input id="password_hidden" name="password" type="hidden" value="" />
<input id="name_hidden" name="name" type="hidden" value="" />
<input id="sword_hidden" name="sword" type="hidden" value="" />
ニックネーム：<input id="nick_hidden" name="nick" type="text" value="" />
<h2>宣言ボタン</h2>
<input class="sengen" type="button" value="宣言する">
<h2>日記</h2>
<textarea cols="80" rows="5" id="diary_input" name="diary"></textarea><br>
<pre id="diary_preview"></pre>
<h2>剣の選択</h2>
■一試合目<br>
壱の剣 <input id="sword1-1" type="number" min="0" max="20" class="mini1">
　
弐の剣 <input id="sword1-2" type="number" min="0" max="20" class="mini1">
<br>
参の剣 <input id="sword1-3" type="number" min="0" max="20" class="mini1">
　
死の剣 <input id="sword1-4" type="number" min="0" max="20" class="mini1">
　
合計 <span id="swordsum1">0</span><br>
■二試合目<br>
壱の剣 <input id="sword2-1" type="number" min="0" max="20" class="mini1">
　
弐の剣 <input id="sword2-2" type="number" min="0" max="20" class="mini1">
<br>
参の剣 <input id="sword2-3" type="number" min="0" max="20" class="mini1">
　
死の剣 <input id="sword2-4" type="number" min="0" max="20" class="mini1">
　
合計 <span id="swordsum2">0</span><br>
■三試合目<br>
壱の剣 <input id="sword3-1" type="number" min="0" max="20" class="mini1">
　
弐の剣 <input id="sword3-2" type="number" min="0" max="20" class="mini1">
<br>
参の剣 <input id="sword3-3" type="number" min="0" max="20" class="mini1">
　
死の剣 <input id="sword3-4" type="number" min="0" max="20" class="mini1">
　
合計 <span id="swordsum3">0</span><br>
<h2>プロフィール</h2>
<textarea cols="80" rows="5" id="profile_input" name="profile"></textarea><br>
<pre id="profile_preview"></pre>
<h2>宣言ボタン</h2>
<input class="sengen" type="button" value="宣言する"><br>
</form>
<br>
<br>
<br>
剣士ギル、罪科持ち（ギルティー）のギルが4本の剣を操っているイメージイラスト<br>
<img src="4th_sword.png" alt="剣士ギル、罪科持ち（ギルティー）のギルが4本の剣を操っているイメージイラスト">
<script>
function toNum(n) {
  return n ? parseInt(n) : 0;
}
function calc() {
  //パワーと名前を更新
  for (var c = 1; c <= 3; c++) {
    for (var i = 1; i <= 4; i++) {
      var name = '#sword'+c+'-'+i;
    }
  }
  //合計値を更新
  var sum1 = toNum($('#sword1-1').val()) + toNum($('#sword1-2').val()) + toNum($('#sword1-3').val()) + toNum($('#sword1-4').val());
  $('#swordsum1').text(sum1 ? sum1 : 0);
  var sum2 = toNum($('#sword2-1').val()) + toNum($('#sword2-2').val()) + toNum($('#sword2-3').val()) + toNum($('#sword2-4').val());
  $('#swordsum2').text(sum2 ? sum2 : 0);
  var sum3 = toNum($('#sword3-1').val()) + toNum($('#sword3-2').val()) + toNum($('#sword3-3').val()) + toNum($('#sword3-4').val());
  $('#swordsum3').text(sum3 ? sum3 : 0);
}
function changeDiary() {
  $('#diary_preview').text($('#diary_input').val().replace(/\+BR\+/g, "\r\n"));
}
function changeProfile() {
  $('#profile_preview').text($('#profile_input').val().replace(/\+BR\+/g, "\r\n"));
}
function applySword(sword) {
  var sword_list = sword.split('：');
  for (var i = 0; i < 12; i++) {
    if (sword_list[i] === undefined || sword_list[i] == "") {
      sword_list[i] = 0;
    }
  }
  $('#sword1-1').val(sword_list[0]);
  $('#sword1-2').val(sword_list[1]);
  $('#sword1-3').val(sword_list[2]);
  $('#sword1-4').val(sword_list[3]);
  $('#sword2-1').val(sword_list[4]);
  $('#sword2-2').val(sword_list[5]);
  $('#sword2-3').val(sword_list[6]);
  $('#sword2-4').val(sword_list[7]);
  $('#sword3-1').val(sword_list[8]);
  $('#sword3-2').val(sword_list[9]);
  $('#sword3-3').val(sword_list[10]);
  $('#sword3-4').val(sword_list[11]);
}
function joinSword() {
  var sword_list = [];
  sword_list[0] = $('#sword1-1').val() || 0;
  sword_list[1] = $('#sword1-2').val() || 0;
  sword_list[2] = $('#sword1-3').val() || 0;
  sword_list[3] = $('#sword1-4').val() || 0;
  sword_list[4] = $('#sword2-1').val() || 0;
  sword_list[5] = $('#sword2-2').val() || 0;
  sword_list[6] = $('#sword2-3').val() || 0;
  sword_list[7] = $('#sword2-4').val() || 0;
  sword_list[8] = $('#sword3-1').val() || 0;
  sword_list[9] = $('#sword3-2').val() || 0;
  sword_list[10] = $('#sword3-3').val() || 0;
  sword_list[11] = $('#sword3-4').val() || 0;
  $('#sword_hidden').val(sword_list.join('：'));
}
$(function() {
  //テキストボックスに変更を加えたら再計算
  $('input[type="number"]').on('change keyup paste', function() {
    calc();
  });
  //ログインボタンを押したら宣言画面を表示
  $('#login_button').on('click', function() {
    var eno = $('#eno').val();
    var password = $('#password').val();
    var error = '';
    if (!eno) {
      error += "ENoが入力されていません。<br>"
    }
    if (!password) {
      error += "パスワードが入力されていません。<br>"
    }
    $('#error').html(error);
    if (error) {
      return;
    }
    $.ajax({
      type: 'POST',
      url: 'login.php',
      data: $('#login').serialize(),
      dataType: 'json',
      timeout: 10000
    }).done(function(json) {
      $('#login').hide();
      $('#otsukare').hide();
      $('#sengen').show();
      $('#eno_show').text(json['ENo']);
      $('#name_show').text(json['name']);
      $('#nick_show').text(json['nick']);
      $('#eno_hidden').val(json['ENo']);
      $('#password_hidden').val($('#password').val());
      $('#name_hidden').val(json['name']);
      $('#nick_hidden').val(json['nick']);
      $('#diary_input').val(json['diary']);
      $('#profile_input').val(json['profile']);
      changeDiary();
      changeProfile();
      applySword(json['sword']);
      calc();
    }).fail(function() {
      alert("何らかの理由でログインが失敗しました。");
    });
  });
  $('.sengen').on('click', function() {
    joinSword();
    $.ajax({
      type: 'POST',
      url: 'keizoku.php',
      data: $('#sengen').serialize(),
      dataType: 'json',
      timeout: 10000
    }).done(function(json) {
      $('#login').show();
      $('#otsukare').show();
      $('#sengen').hide();
    }).fail(function() {
      alert("何らかの理由で宣言が失敗しました。");
    });
  });
  //日記のプレビュー
  $('#diary_input').on('change keypress keyup', function() {
    changeDiary();
  });
  //プロフィールのプレビュー
  $('#profile_input').on('change keypress keyup', function() {
    changeProfile();
  });
});
</script>
</body>
</html>